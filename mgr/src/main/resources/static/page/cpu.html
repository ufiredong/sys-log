<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>ECharts</title>
</head>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<link rel="stylesheet" href="https://www.layuicdn.com/layui-v2.5.5/css/layui.css"  media="all">
<body>
<div id="main" style="height:400px"></div>
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;
    margin-right: 100px;
    margin-left: 100px;">
    <legend>CPU信息实时采集</legend>
</fieldset>
<div class="layui-form" style="
    margin-right: 100px;
    margin-left: 100px;
">
    <table class="layui-table">
        <colgroup>
            <col width="150">
            <col width="150">
            <col width="200">
            <col>
        </colgroup>
        <thead>
        <tr>
            <th>用户CPU百分比</th>
            <th>系统CPU百分比</th>
            <th>空闲CPU百分比</th>
            <th>CPU使用率</th>
            <th>SNMP采集时间</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td id="ssCpuUser">0</td>
            <td id="ssCpuSystem">0</td>
            <td id="ssCpuIdle">0</td>
            <td id="rate">0</td>
            <td id="createTime">0</td>
        </tr>
        </tbody>
    </table>
</div>
<script type="text/javascript">

    // 基于准备好的dom，初始化echarts图表
    var myChart=echarts.init(document.getElementById("main"));
    function randomData() {
        now = new Date(+now + oneDay);
        var valueX=[now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/')+" "+[now.getHours(), now.getMinutes(), now.getSeconds()].join(':');
        console.log(valueX);
        return {
            value: [
                valueX,
                0
            ]
        }
    }
    var data = [];
    var now = +new Date();
    var oneDay = 1*1000;
    for (var i = 0; i < 30; i++) {
        data.push(randomData());
    }
    option = {
        title : {
            text: '',
        },
        tooltip : {
            trigger:"axis",
            formatter:"{a}<br>{c}"
        },
        toolbox: {
            show : true,
            feature : {
                restore : {show: true},
                saveAsImage : {show: true}
            }
        },
        calculable : true,
        xAxis : [
            {
                type : 'time',
                nameLocation:'middle',
                boundaryGap : false,
                axisTick:{
                    show:false
                },
                axisLabel:{
                    show:false
                },
                splitLine: {
                    show: false
                }
            }
        ],
        yAxis : [
            {
                type : 'value',
                min:0,
                max:100,
                splitLine: {
                    show: false
                },
                position:'right'
            }
        ],
        series : [
            {
                name:'cpu使用率',
                type:'line',
                data:data,
                showSymbol: false,
                hoverAnimation: false,
                markPoint: {
                    data: [
                        {type: 'max', name: '最大值'},
                        {type: 'min', name: '最小值'}
                    ]
                }
            }
        ]
    };
    myChart.setOption(option);

    // setTimeout(function(){setInterval(function () {
    //     now = new Date(+now + oneDay);
    //     var value;
    //     value=Math.ceil(Math.random()*100);
    //     option.xAxis[0].name="当前cpu使用率："+value+"%";
    //     var nowX=[now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/')+" "+[now.getHours(), now.getMinutes(), now.getSeconds()].join(':');
    //     var dataObj={
    //         name: now.toString(),
    //         value: [
    //             nowX,
    //             Math.round(value)
    //         ]
    //     }
    //     data.shift();
    //     console.info(dataObj)
    //     data.push(dataObj);
    //     myChart.setOption(option);
    // }, 1000);},1000)

    var websocket = null;

    //判断当前浏览器是否支持WebSocket, 主要此处要更换为自己的地址
    if ('WebSocket' in window) {
        websocket = new WebSocket("ws://127.0.0.1:9090/socket/cpuinfo");
    } else {
        alert('Not support websocket')
    }

    //连接发生错误的回调方法
    websocket.onerror = function() {

    };

    //连接成功建立的回调方法
    websocket.onopen = function(event) {

    }

    //接收到消息的回调方法
    websocket.onmessage = function(event) {
        var cpuInfo = JSON.parse(event.data);
        document.getElementById("ssCpuUser").innerText=cpuInfo.ssCpuUser
        document.getElementById("ssCpuSystem").innerText=cpuInfo.ssCpuSystem
        document.getElementById("ssCpuIdle").innerText=cpuInfo.ssCpuIdle
        document.getElementById("rate").innerText=cpuInfo.rate
        document.getElementById("createTime").innerText=cpuInfo.createTime
        now = new Date(+now + oneDay);
        var value=cpuInfo.rate;
        // value=Math.ceil(Math.random()*100);
        option.xAxis[0].name="当前cpu使用率："+value+"%";
        var nowX=[now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/')+" "+[now.getHours(), now.getMinutes(), now.getSeconds()].join(':');
        var dataObj={
            name: now.toString(),
            value: [
                nowX,
                Math.round(value)
            ]
        }
        data.shift();
        data.push(dataObj);
        myChart.setOption(option);
    }

    //连接关闭的回调方法
    websocket.onclose = function() {

    }

    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function() {
        websocket.close();
    }

    //将消息显示在网页上
    function setMessageInnerHTML(innerHTML) {


    }

    //关闭连接
    function closeWebSocket() {
        websocket.close();
    }

    //发送消息
    function send() {
    }




</script>
</body>